version: '3.8'

services:
  # Backend Core - API Gateway and Session Management
  backend-core:
    build:
      context: ./services/backend-core
      dockerfile: Dockerfile
    container_name: tab-organizer-backend
    ports:
      - "8080:8080"
    environment:
      - AI_ENGINE_URL=http://ai-engine:8090
      - BROWSER_ENGINE_URL=http://browser-engine:8083
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
    depends_on:
      - ai-engine
      - browser-engine
      - qdrant
    networks:
      - tab-organizer-network
    restart: unless-stopped
    profiles:
      - default
      - dev

  # AI Engine - Embeddings, Clustering, Chat
  ai-engine:
    build:
      context: ./services/ai-engine
      dockerfile: Dockerfile
    container_name: tab-organizer-ai
    ports:
      - "8090:8090"
    environment:
      - AI_PROVIDER=${AI_PROVIDER:-ollama}
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-ollama}
      - LLM_MODEL=${LLM_MODEL:-llama3.2:3b}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-nomic-embed-text}
      - EMBEDDING_DIMENSIONS=${EMBEDDING_DIMENSIONS:-768}
      - OLLAMA_HOST=${OLLAMA_HOST:-http://ollama:11434}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
    depends_on:
      - qdrant
      - ollama
    networks:
      - tab-organizer-network
    restart: unless-stopped
    profiles:
      - default
      - dev

  # Browser Engine - Scraping and Auth
  browser-engine:
    build:
      context: ./services/browser-engine
      dockerfile: Dockerfile
    container_name: tab-organizer-browser
    ports:
      - "8083:8083"
    environment:
      - BACKEND_URL=http://backend-core:8080
      - AI_ENGINE_URL=http://ai-engine:8090
      - MAX_CONCURRENT_SCRAPES=${MAX_CONCURRENT_SCRAPES:-10}
      - SCRAPE_TIMEOUT=${SCRAPE_TIMEOUT:-30}
      - RESPECT_ROBOTS=${RESPECT_ROBOTS:-true}
      - CREDENTIAL_ENCRYPTION_KEY=${CREDENTIAL_ENCRYPTION_KEY:-}
    networks:
      - tab-organizer-network
    restart: unless-stopped
    profiles:
      - default
      - dev

  # Web UI - Streamlit
  web-ui:
    build:
      context: ./services/web-ui
      dockerfile: Dockerfile
    container_name: tab-organizer-ui
    ports:
      - "8089:8089"
    environment:
      - BACKEND_URL=http://backend-core:8080
      - AI_ENGINE_URL=http://ai-engine:8090
      - BROWSER_ENGINE_URL=http://browser-engine:8083
    depends_on:
      - backend-core
    networks:
      - tab-organizer-network
    restart: unless-stopped
    profiles:
      - default
      - dev

  # Qdrant - Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: tab-organizer-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - tab-organizer-network
    restart: unless-stopped
    profiles:
      - default
      - dev

  # Ollama - Local LLM (optional)
  ollama:
    image: ollama/ollama:latest
    container_name: tab-organizer-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - tab-organizer-network
    restart: unless-stopped
    profiles:
      - default
      - dev

  # Test services
  test-unit:
    build:
      context: .
      dockerfile: tests/Dockerfile.test
    container_name: tab-organizer-test-unit
    command: pytest tests/unit -v --cov=services --cov-report=xml --cov-report=html --cov-report=term
    volumes:
      - ./tests:/app/tests
      - ./services:/app/services
      - ./test-results:/app/test-results
      - ./coverage:/app/coverage
    networks:
      - tab-organizer-network
    profiles:
      - test-unit

  test-integration:
    build:
      context: .
      dockerfile: tests/Dockerfile.test
    container_name: tab-organizer-test-integration
    command: pytest tests/integration -v --junit-xml=/app/test-results/integration-results.xml
    environment:
      - BACKEND_URL=http://backend-core:8080
      - AI_ENGINE_URL=http://ai-engine:8090
      - BROWSER_ENGINE_URL=http://browser-engine:8083
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - OLLAMA_HOST=http://ollama:11434
    volumes:
      - ./tests:/app/tests
      - ./services:/app/services
      - ./test-results:/app/test-results
    depends_on:
      - backend-core
      - ai-engine
      - browser-engine
      - qdrant
      - ollama
    networks:
      - tab-organizer-network
    profiles:
      - test-integration

  test-e2e:
    build:
      context: .
      dockerfile: tests/Dockerfile.test
    container_name: tab-organizer-test-e2e
    command: pytest tests/e2e -v --junit-xml=/app/test-results/e2e-results.xml
    environment:
      - WEB_UI_URL=http://web-ui:8089
      - BACKEND_URL=http://backend-core:8080
      - AI_ENGINE_URL=http://ai-engine:8090
      - BROWSER_ENGINE_URL=http://browser-engine:8083
    volumes:
      - ./tests:/app/tests
      - ./test-results:/app/test-results
    depends_on:
      - web-ui
      - backend-core
      - ai-engine
      - browser-engine
      - qdrant
      - ollama
    networks:
      - tab-organizer-network
    profiles:
      - test-e2e

networks:
  tab-organizer-network:
    driver: bridge

volumes:
  qdrant-data:
  ollama-data:
